---
title: "Problem Set 3"
author:
  - Your Name Here
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
    toc-title: Contents
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())

library(latex2exp)
library(paletteer)
library(ggrepel)
library(lubridate)
```


## Setting up a reusable theme

For this problem set, we will create a reusable theme that we can apply to each plot. This is similar to the process that you would use when designing slides for manuscripts, posters, or presentations. In those cases, you would likely make the plots first and then modify them to fit.

Here we will make the theme first, since we will use it for all the plots in this problem set. Additionally, while you would be outputting files as PDF or an image format normally, we'll just use the native Quarto html rendering. We can still make a theme.

The code chunk below makes a basic plot with some points. We don't care now about the contents of the plot. 

```{r}
## FIXME
ggplot(data = tibble(x = 1:10, y = runif(10)),
       aes(x, y)) +
  geom_point()
```

Now put the `theme()` elements into a list and save that so you can reuse it

## Floristic diversity

Myrtaceae, Fabaceae, Santalaceae, etc.

```{r}
D <- read_csv("../Data/Floristic_composition_and_Diversity.csv",
              show_col_types = FALSE) |> 
  mutate(Diameter_m = Diameter_cm / 100,
         Family = fct_infreq(Family))

ggplot(D, aes(Diameter_m, Height_m, color = Family)) +
  geom_abline(slope = 0.728, intercept = 1.5967) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap("Family") +
  coord_equal()
```


## Shark physiology

Blacktip reef shark (*Carcharhinus melanopterus*)

![](https://upload.wikimedia.org/wikipedia/commons/0/01/Carcharhinus_melanopterus_mirihi.jpg)

```{r}
library(ggrepel)
Shark <- read_csv("../Data/bouyoucos_et_al_activity.csv",
                  show_col_types = FALSE) |> 
  mutate(temp = str_remove(temp, "C") |> factor(),
         pco2 = str_remove(pco2, "uatm") |> factor(levels = c(650, 1050)))

Shark |> arrange(desc(activity)) |> slice(1)

Shark <- Shark |> 
  mutate(Label = if_else(shark == "Cm47", "Cm47", ""))

ggplot(Shark, aes(y = activity, x = pco2, color = temp, label = Label)) +
  geom_point(size = 4, position = position_jitter(width = 0.05, seed = 48727)) +
  geom_text_repel(box.padding = 0.5, seed = 17346) +
  labs(y = "Activity", x = expression(pCO[2])) +
  scale_color_discrete(name = "Temperature (C)")
```


## Spiny damselfish respirometry

![](https://upload.wikimedia.org/wikipedia/commons/e/e3/Acanthochromis_polyacanthus.jpg)


Rodgers, Giverny (2018): A comparison of closed system and flow-through respirometry techniques using adult *Acanthochromis polyacanthus*. James Cook University. [https://doi.org/10.4225/28/5ab08a55baf15](https://doi.org/10.4225/28/5ab08a55baf15)

Six adult spiny chromis damselfish (Acanthochromis polyacanthus) were used to compare closed system and flow-through respirometry techniques.

oxygen consumption of each fish in mg of O~2~ consumed kg^-1^ h^-1^

```{r}
D <- read_csv("../Data/A_polyacanthus_respirometry.csv",
              show_col_types = FALSE)

D_long <- D |> 
  pivot_longer(cols = -Time_min, values_to = "O2_Consumption") |> 
  separate(col = name, into = c("Treatment", "ID"), sep = "-") |> 
  mutate(Treatment = factor(Treatment, levels = c("Static", "Recirculation")),
         ID = factor(ID))

ggplot(D_long,
       aes(x = Time_min, y = O2_Consumption,
           linetype = Treatment, color = ID)) +
  geom_line() +
  facet_grid(ID ~ .) +
  labs(y = expression(Oxygen~consumption~(mg~O[2]~kg^-1~hr^-1)),
       x = "Time (min)")
```

Reaction norm at 120 min

```{r}
D_120 <- D_long |>
  filter(Time_min == 120)

ggplot(D_120, aes(x = Treatment, y = O2_Consumption, group = ID)) +
  geom_point() +
  geom_line() +
  labs(y = TeX("$Oxygen~Consumption~(\\frac{mg~O_2}{kg / hr})$"),
       x = "Time (min)")
```

Add mean and 2 x SEM

```{r}

```

Calculate per-fish difference

```{r}
D_diff <- D_120 |> 
  select(-Time_min) |> 
  pivot_wider(names_from = "Treatment", values_from = "O2_Consumption") |> 
  mutate(d = Static - Recirculation)

t.test(D_diff$d, mu = 0)
```


## Snow GR

```{r}
library(lubridate)
GR <- read_csv("../Data/GR_Snow.csv",
               show_col_types = FALSE)

ggplot(GR, aes(SeasonStart, Total)) +
  geom_line()
```

```{r}
GR_long <- GR |> 
  filter(SeasonStart >= 1960) |> 
  select(-SeasonEnd, -Total) |> 
  pivot_longer(cols = -SeasonStart, names_to = "Month", values_to = "Snow") |> 
  mutate(Date = ym(paste(SeasonStart, Month, sep = "-")))

ggplot(GR_long, aes(x = Date, y = Snow)) +
  geom_line()
```

```{r}
GR_long |> arrange(desc(Snow)) |> slice(1)
```


```{r}
Decades <- tribble(
  ~ Start, ~ End,
  ym("1960-Jul"), ym("1970-Jun"),
  ym("1980-Jul"), ym("1990-Jun"),
  ym("2000-Jul"), ym("2010-Jun")
)

ggplot() +
  geom_rect(data = Decades,
            aes(xmin = Start, xmax = End,
                ymin = 0, ymax = Inf),
            fill = "gray80") +
  geom_line(data = GR_long,
            aes(x = Date, y = Snow))
```


```{r}
ggplot() +
  geom_rect(data = Decades,
            aes(xmin = Start, xmax = End,
                ymin = 0, ymax = Inf),
            fill = "gray80") +
  geom_line(data = GR_long,
            aes(x = Date, y = Snow)) +
  geom_point(data = GR_long |> arrange(desc(Snow)) |> slice(1),
             aes(x = Date, y = Snow),
             color = "red",
             size = 3) +
  annotate(geom = "text",
           label = "December, 2000: 59.2 in",
           x = ym("1993-Oct"),
           y = 60,
           size = 5) +
  scale_x_date(breaks = seq(ym("1960-Jul"), ym("2010-Jun"), by = "5 years"),
               date_labels = "%Y",
               name = "Year")

```

